<?xml version="1.0" encoding="UTF-8"?>

<project name="craft-maps" default="dist">

    <property file="build.properties" />
    <property name="dist.name" value="${build.dir}/${project.name}-${project.version}.zip" />

    <property name="project.license" value="
        /**
         * @package   Craft Maps
         * @author    Mario Friz
         * @copyright Copyright (c) 2013, Mario Friz
         */
    " />

    <!-- Fileset for all files -->
    <fileset dir="${base.dir}" id="allfiles">
        <include name="**" />
        <exclude name="**/ts/"/>
        <exclude name="build/" />
    </fileset>

    <target name="clean">
        <echo msg="Cleaning..." />
        <delete dir="${build.tempDir}" includeemptydirs="true" verbose="false" failonerror="false" />
        <delete verbose="false" failonerror="false">
            <fileset dir="${build.dir}">
                <include name="*.zip" />
            </fileset>
        </delete>
    </target>

    <target name="prepare" depends="clean">
        <propertyprompt propertyName="project.version" defaultValue="" promptText="Enter the version" />
        <echo msg="Making directory ${build.tempDir}" />
        <mkdir dir="${build.tempDir}" />
    </target>

    <target name="build" depends="prepare">
        <echo msg="Copying files to build directory..." />

        <copy todir="${build.tempDir}">
            <fileset refid="allfiles" />
            <filterchain>
                <stripphpcomments />
                <replacetokens>
                    <token key="version" value="${project.version}" />
                </replacetokens>
                <replaceregexp>
                    <regexp pattern="&lt;\?php" replace="" ignoreCase="true"/>
                </replaceregexp>
            </filterchain>
        </copy>
    </target>

    <target name="minify" depends="build">
        <echo msg="Minifying js and css..." />
        <foreach param="filename" absparam="absfilename" target="minify.file">
            <fileset dir="${build.tempDir}" includes="**/*.css, **/*.js" />
        </foreach>
    </target>

    <target name="minify.file">
        <php expression="str_replace(DIRECTORY_SEPARATOR, '/', '${absfilename}')" returnProperty="newfilename"/>
        <echo msg="Minifying ${newfilename}..." />
        <property name="yuicommand" value="java -jar yuicompressor-2.4.6.jar ${newfilename} -o ${newfilename}" />
        <exec command="${yuicommand}" />
    </target>

    <target name="licensing" depends="minify">
        <echo msg="Licensing..." />
        <foreach param="filename" absparam="absfilename" target="license.file">
            <fileset dir="${build.tempDir}" includes="**/*.php, **/*.css, **/*.js" />
        </foreach>
    </target>

    <target name="license.file">
        <echo msg="Licensing ${absfilename}..." />
        <if>
            <contains string="${absfilename}" substring=".php" casesensitive="false" />
            <then>
                <append destFile="${absfilename}-temp" text="&lt;?php ${line.separator}${line.separator}" />
            </then>
        </if>
        <append destFile="${absfilename}-temp" file="${build.dir}/license.txt" />
        <append destFile="${absfilename}-temp" file="${absfilename}" />
        <move file="${absfilename}-temp" tofile="${absfilename}" overwrite="true"/>
    </target>

    <target name="dist" depends="licensing">
        <echo msg="Creating archive..." />

        <zip destfile="${dist.name}">
            <fileset dir="${build.dir}">
                <include name="${project.name}/" />
            </fileset>
        </zip>

        <echo msg="Files copied and compressed in build directory OK!" />
    </target>
</project>